
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Link Generator Pro - With Twilio Lookup</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            max-width: 1100px;
            width: 100%;
            overflow: hidden;
        }

        .header {
            background: #25D366;
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            min-width: 120px;
            padding: 18px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
            background: #f5f5f5;
            border: none;
            font-size: 15px;
        }

        .tab:hover {
            background: #e8e8e8;
        }

        .tab.active {
            background: white;
            color: #25D366;
            border-bottom: 3px solid #25D366;
        }

        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        input[type="text"],
        input[type="password"],
        input[type="file"],
        select {
            width: 100%;
            padding: 14px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input[type="text"]:focus,
        input[type="password"]:focus,
        select:focus {
            outline: none;
            border-color: #25D366;
            box-shadow: 0 0 0 3px rgba(37, 211, 102, 0.1);
        }

        input[type="file"] {
            padding: 12px;
            cursor: pointer;
        }

        .btn {
            background: #25D366;
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover {
            background: #1fb855;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(37, 211, 102, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #128C7E;
        }

        .btn-secondary:hover {
            background: #0e6b61;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            width: auto;
            margin: 0;
        }

        .btn-twilio {
            background: #F22F46;
        }

        .btn-twilio:hover {
            background: #d91e36;
        }

        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .alert-info {
            background: #e3f2fd;
            color: #1976d2;
            border-left: 4px solid #1976d2;
        }

        .alert-success {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #2e7d32;
        }

        .alert-warning {
            background: #fff3e0;
            color: #f57c00;
            border-left: 4px solid #f57c00;
        }

        .alert-error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #c62828;
        }

        .results-table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
            display: none;
        }

        .results-table.show {
            display: table;
            animation: fadeIn 0.3s ease;
        }

        .results-table th {
            background: #f5f5f5;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #ddd;
            font-size: 14px;
        }

        .results-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
            font-size: 14px;
        }

        .results-table tr:hover {
            background: #f9f9f9;
        }

        .link-cell {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .link-cell a {
            color: #25D366;
            text-decoration: none;
            word-break: break-all;
            flex: 1;
        }

        .link-cell a:hover {
            text-decoration: underline;
        }

        .btn-copy {
            padding: 6px 12px;
            background: #128C7E;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            white-space: nowrap;
        }

        .btn-copy:hover {
            background: #0e6b61;
        }

        .file-info {
            background: #e8f5e9;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 14px;
            color: #2e7d32;
            display: none;
        }

        .file-info.show {
            display: block;
        }

        .stats {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .stat-card {
            flex: 1;
            min-width: 140px;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #e0e0e0;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #25D366;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .download-section {
            margin-top: 20px;
            display: none;
        }

        .download-section.show {
            display: block;
        }

        .results-container {
            max-height: 500px;
            overflow-y: auto;
            margin-top: 20px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 10px;
            display: none;
        }

        .results-container.show {
            display: block;
        }

        .column-selector {
            background: #f0f7ff;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #1976d2;
            display: none;
        }

        .column-selector.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .column-selector h3 {
            color: #1976d2;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .selector-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .selector-item {
            display: flex;
            flex-direction: column;
        }

        .selector-item label {
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .detection-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 10px;
        }

        .detection-status.success {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .detection-status.warning {
            background: #fff3e0;
            color: #f57c00;
        }

        .preview-box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid #ddd;
        }

        .preview-box h4 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .preview-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .preview-item {
            font-size: 14px;
        }

        .preview-item strong {
            color: #333;
            display: block;
            margin-bottom: 4px;
        }

        .history-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
        }

        .history-table-container {
            max-height: 600px;
            overflow-y: auto;
            background: #f9f9f9;
            border-radius: 10px;
            padding: 10px;
        }

        .timestamp {
            color: #666;
            font-size: 12px;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 5px;
        }

        .badge-new {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .badge-updated {
            background: #fff3e0;
            color: #f57c00;
        }

        .badge-mobile {
            background: #e3f2fd;
            color: #1976d2;
        }

        .badge-landline {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .badge-voip {
            background: #fce4ec;
            color: #c2185b;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .credentials-box {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .credentials-box h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .credentials-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .save-indicator {
            display: inline-block;
            margin-left: 10px;
            color: #2e7d32;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .save-indicator.show {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .container {
                border-radius: 10px;
            }

            .header h1 {
                font-size: 24px;
            }

            .tab {
                padding: 14px;
                font-size: 14px;
                min-width: 100px;
            }

            .tab-content {
                padding: 20px;
            }

            .results-table {
                font-size: 12px;
            }

            .results-table th,
            .results-table td {
                padding: 8px;
            }

            .link-cell {
                flex-direction: column;
                align-items: flex-start;
            }

            .link-cell a {
                font-size: 12px;
            }

            .btn-copy {
                width: 100%;
            }

            .selector-grid,
            .credentials-grid {
                grid-template-columns: 1fr;
            }

            .preview-row {
                grid-template-columns: 1fr;
            }

            .history-controls {
                flex-direction: column;
            }

            .search-box {
                width: 100%;
            }
        }

        .input-row {
            display: flex;
            gap: 15px;
        }

        .input-row .input-group {
            flex: 1;
        }

        @media (max-width: 600px) {
            .input-row {
                flex-direction: column;
            }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #2e7d32;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
            animation: slideIn 0.3s ease;
            max-width: 300px;
        }

        .notification.show {
            display: block;
        }

        .notification.error {
            background: #dc3545;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #25D366;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📱 WhatsApp Link Generator Pro</h1>
            <p>With Twilio Number Lookup & History Tracking</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('single')">Generate</button>
            <button class="tab" onclick="switchTab('bulk')">Upload CSV</button>
            <button class="tab" onclick="switchTab('twilio')">Twilio Lookup</button>
            <button class="tab" onclick="switchTab('history')">
                History 
                <span id="historyCount" class="badge badge-new" style="display: none;">0</span>
            </button>
            <button class="tab" onclick="switchTab('settings')">Settings</button>
        </div>

        <!-- Single Number Generator Tab -->
        <div id="single" class="tab-content active">
            <div class="alert alert-info">
                Enter business details and phone number with country code
            </div>

            <div class="input-row">
                <div class="input-group">
                    <label for="businessName">Business Name (Optional)</label>
                    <input 
                        type="text" 
                        id="businessName" 
                        placeholder="e.g., ABC Company"
                        autocomplete="off"
                    >
                </div>

                <div class="input-group">
                    <label for="phoneNumber">Phone Number</label>
                    <input 
                        type="text" 
                        id="phoneNumber" 
                        placeholder="e.g., +1 234 567 8900"
                        autocomplete="off"
                    >
                </div>
            </div>

            <button class="btn" onclick="generateSingleLink()">Generate Link</button>
            <button class="btn btn-twilio" onclick="generateWithTwilio()">Generate Link + Twilio Lookup</button>

            <table id="singleResultTable" class="results-table">
                <thead>
                    <tr>
                        <th>Business Name</th>
                        <th>Phone Number</th>
                        <th>Type</th>
                        <th>Carrier</th>
                        <th>Country</th>
                        <th>WhatsApp Link</th>
                    </tr>
                </thead>
                <tbody id="singleResultBody">
                </tbody>
            </table>
        </div>

        <!-- Bulk CSV Generator Tab -->
        <div id="bulk" class="tab-content">
            <div class="alert alert-info">
                Upload a CSV file - the app will auto-detect columns or let you select manually
            </div>

            <div class="input-group">
                <label for="csvFile">Choose CSV File</label>
                <input 
                    type="file" 
                    id="csvFile" 
                    accept=".csv"
                    onchange="handleFileSelect(event)"
                >
                <div id="fileInfo" class="file-info"></div>
            </div>

            <!-- Column Selector -->
            <div id="columnSelector" class="column-selector">
                <h3>📊 Select Column Mapping</h3>
                <div class="selector-grid">
                    <div class="selector-item">
                        <label>
                            Business Name Column
                            <span id="nameDetectionStatus" class="detection-status"></span>
                        </label>
                        <select id="nameColumnSelect">
                            <option value="">-- None / Skip --</option>
                        </select>
                    </div>
                    <div class="selector-item">
                        <label>
                            Phone Number Column
                            <span id="phoneDetectionStatus" class="detection-status"></span>
                        </label>
                        <select id="phoneColumnSelect">
                            <option value="">-- Select Column --</option>
                        </select>
                    </div>
                </div>
                
                <div class="preview-box">
                    <h4>📋 Preview (First Row)</h4>
                    <div id="previewContent"></div>
                </div>

                <button class="btn btn-secondary" onclick="confirmColumnSelection()">Process Without Twilio</button>
                <button class="btn btn-twilio" onclick="confirmColumnSelectionWithTwilio()">Process With Twilio Lookup</button>
            </div>

            <div id="bulkStats" class="stats" style="display: none;">
                <div class="stat-card">
                    <div class="stat-number" id="totalProcessed">0</div>
                    <div class="stat-label">Total Rows</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalSuccess">0</div>
                    <div class="stat-label">Valid Links</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalMobile">0</div>
                    <div class="stat-label">Mobile Numbers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalDuplicates">0</div>
                    <div class="stat-label">Duplicates</div>
                </div>
            </div>

            <div id="resultsContainer" class="results-container">
                <table class="results-table show">
                    <thead>
                        <tr>
                            <th>Business Name</th>
                            <th>Phone Number</th>
                            <th>Type</th>
                            <th>Carrier</th>
                            <th>Country</th>
                            <th>WhatsApp Link</th>
                        </tr>
                    </thead>
                    <tbody id="bulkResultsBody">
                    </tbody>
                </table>
            </div>

            <div id="downloadSection" class="download-section">
                <button class="btn btn-secondary" onclick="downloadCSV()">⬇️ Download Results as CSV</button>
            </div>
        </div>

        <!-- Twilio Lookup Tab -->
        <div id="twilio" class="tab-content">
            <div class="alert alert-info">
                Use Twilio API to lookup phone number details. Configure your credentials in Settings first.
            </div>

            <div class="input-group">
                <label for="twilioPhone">Phone Number to Lookup</label>
                <input 
                    type="text" 
                    id="twilioPhone" 
                    placeholder="e.g., +1 234 567 8900"
                    autocomplete="off"
                >
            </div>

            <button class="btn btn-twilio" onclick="twilioSingleLookup()">
                Lookup Number
                <span id="twilioLoading" style="display: none;" class="loading"></span>
            </button>

            <div id="twilioResult" style="margin-top: 20px; display: none;">
                <div class="alert alert-success">
                    <h4 style="margin-bottom: 10px;">📊 Lookup Results</h4>
                    <div id="twilioResultContent"></div>
                </div>
            </div>

            <div style="margin-top: 30px;">
                <h3 style="margin-bottom: 15px;">Bulk Twilio Lookup</h3>
                <div class="alert alert-warning">
                    Upload a CSV file with phone numbers to perform bulk Twilio lookups
                </div>
                
                <div class="input-group">
                    <label for="twilioCsvFile">Choose CSV File</label>
                    <input 
                        type="file" 
                        id="twilioCsvFile" 
                        accept=".csv"
                        onchange="handleTwilioFileSelect(event)"
                    >
                </div>

                <button class="btn btn-twilio" id="twilioBulkBtn" onclick="twilioBulkLookup()" disabled>
                    Perform Bulk Lookup
                    <span id="twilioBulkLoading" style="display: none;" class="loading"></span>
                </button>

                <div id="twilioBulkResults" style="margin-top: 20px; display: none;">
                    <div class="alert alert-success">
                        <h4 style="margin-bottom: 10px;">📊 Bulk Lookup Results</h4>
                        <table id="twilioBulkTable" class="styled-table" style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>Phone Number</th>
                                    <th>Type</th>
                                    <th>Carrier</th>
                                    <th>Country</th>
                                    <th>Valid</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="twilioBulkBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div id="history" class="tab-content">
            <div class="history-controls">
                <div class="search-box">
                    <input 
                        type="text" 
                        id="historySearch" 
                        placeholder="🔍 Search by business name or phone number..."
                        onkeyup="filterHistory()"
                    >
                </div>
                <button class="btn btn-secondary btn-small" onclick="exportHistory()">📥 Export History</button>
                <button class="btn btn-danger btn-small" onclick="clearHistory()">🗑️ Clear History</button>
            </div>

            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalHistoryCount">0</div>
                    <div class="stat-label">Total Entries</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="uniqueBusinesses">0</div>
                    <div class="stat-label">Unique Businesses</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="mobileCount">0</div>
                    <div class="stat-label">Mobile Numbers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="todayCount">0</div>
                    <div class="stat-label">Added Today</div>
                </div>
            </div>

            <div class="history-table-container">
                <table id="historyTable" class="results-table show">
                    <thead>
                        <tr>
                            <th>Business Name</th>
                            <th>Phone Number</th>
                            <th>Type</th>
                            <th>Carrier</th>
                            <th>Country</th>
                            <th>WhatsApp Link</th>
                            <th>Last Updated</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody">
                    </tbody>
                </table>
                <div id="emptyHistory" class="empty-state" style="display: none;">
                    <div class="empty-state-icon">📭</div>
                    <h3>No History Yet</h3>
                    <p>Start generating WhatsApp links to build your history</p>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <div class="credentials-box">
                <h3>🔐 Twilio Credentials</h3>
                <div class="alert alert-warning">
                    Your credentials are stored locally in your browser and never sent anywhere except to Twilio's API
                </div>
                
                <div class="credentials-grid">
                    <div class="input-group">
                        <label for="twilioSid">Account SID</label>
                        <input 
                            type="text" 
                            id="twilioSid" 
                            placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
                            onchange="saveCredentials()"
                        >
                    </div>
                    <div class="input-group">
                        <label for="twilioToken">Auth Token</label>
                        <input 
                            type="password" 
                            id="twilioToken" 
                            placeholder="Your Auth Token"
                            onchange="saveCredentials()"
                        >
                    </div>
                </div>
                
                <span id="credentialsSaved" class="save-indicator">✅ Credentials saved</span>
                
                <div style="margin-top: 20px;">
                    <button class="btn btn-secondary btn-small" onclick="testTwilioConnection()">Test Connection</button>
                    <button class="btn btn-danger btn-small" onclick="clearCredentials()">Clear Credentials</button>
                </div>
            </div>

            <div class="alert alert-info" style="margin-top: 20px;">
                <h4>ℹ️ How to get Twilio credentials:</h4>
                <ol style="margin-top: 10px; padding-left: 20px;">
                    <li>Sign up for a Twilio account at twilio.com</li>
                    <li>Go to your Twilio Console</li>
                    <li>Find your Account SID and Auth Token</li>
                    <li>Enable the Lookup API in your account</li>
                </ol>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        // ============================================
        // GLOBAL VARIABLES AND INITIALIZATION
        // ============================================
        
        let bulkData = [];
        let csvData = [];
        let csvHeaders = [];
        let selectedColumns = {
            name: null,
            phone: null
        };
        let history = [];
        let twilioCredentials = {
            sid: '',
            token: ''
        };
        let twilioCsvData = [];

        // Load saved data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadHistory();
            loadCredentials();
            updateHistoryStats();
            displayHistory();

            // Setup event listeners
            document.getElementById('phoneNumber').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    generateSingleLink();
                }
            });

            document.getElementById('businessName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('phoneNumber').focus();
                }
            });

            document.getElementById('twilioPhone').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    twilioSingleLookup();
                }
            });
        });

        // ============================================
        // LOCAL STORAGE MANAGEMENT
        // ============================================
        
        // Load history from localStorage
        function loadHistory() {
            const stored = localStorage.getItem('whatsappHistory');
            if (stored) {
                try {
                    history = JSON.parse(stored);
                } catch (e) {
                    console.error('Error loading history:', e);
                    history = [];
                }
            }
        }

        // Save history to localStorage
        function saveHistory() {
            try {
                localStorage.setItem('whatsappHistory', JSON.stringify(history));
                updateHistoryStats();
                showNotification('✅ Saved to history');
            } catch (e) {
                console.error('Error saving history:', e);
                showNotification('❌ Error saving to history', 'error');
            }
        }

        // Load Twilio credentials from localStorage
        function loadCredentials() {
            const stored = localStorage.getItem('twilioCredentials');
            if (stored) {
                try {
                    twilioCredentials = JSON.parse(stored);
                    document.getElementById('twilioSid').value = twilioCredentials.sid || '';
                    document.getElementById('twilioToken').value = twilioCredentials.token || '';
                } catch (e) {
                    console.error('Error loading credentials:', e);
                }
            }
        }

        // Save Twilio credentials to localStorage
        function saveCredentials() {
            twilioCredentials.sid = document.getElementById('twilioSid').value;
            twilioCredentials.token = document.getElementById('twilioToken').value;
            
            try {
                localStorage.setItem('twilioCredentials', JSON.stringify(twilioCredentials));
                const indicator = document.getElementById('credentialsSaved');
                indicator.classList.add('show');
                setTimeout(() => indicator.classList.remove('show'), 2000);
            } catch (e) {
                console.error('Error saving credentials:', e);
                showNotification('❌ Error saving credentials', 'error');
            }
        }

        // Clear Twilio credentials
        function clearCredentials() {
            if (confirm('Are you sure you want to clear your Twilio credentials?')) {
                twilioCredentials = { sid: '', token: '' };
                localStorage.removeItem('twilioCredentials');
                document.getElementById('twilioSid').value = '';
                document.getElementById('twilioToken').value = '';
                showNotification('✅ Credentials cleared');
            }
        }

        // ============================================
        // HISTORY MANAGEMENT
        // ============================================
        
        // Add or update history entry
        function addToHistory(businessName, phone, link, twilioData = null) {
            const timestamp = new Date().toISOString();
            
            // Check if phone number already exists
            const existingIndex = history.findIndex(item => item.phone === phone);
            
            const entry = {
                businessName: businessName,
                phone: phone,
                link: link,
                timestamp: timestamp,
                type: twilioData?.type || 'unknown',
                carrier: twilioData?.carrier || 'N/A',
                country: twilioData?.country || 'N/A',
                updated: false
            };
            
            if (existingIndex !== -1) {
                // Update existing entry
                history[existingIndex] = { ...history[existingIndex], ...entry, updated: true };
                // Move to top
                const updated = history.splice(existingIndex, 1)[0];
                history.unshift(updated);
                return 'updated';
            } else {
                // Add new entry at the beginning
                history.unshift(entry);
                return 'new';
            }
        }

        // ============================================
        // UI MANAGEMENT
        // ============================================
        
        // Switch between tabs
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');

            // Refresh history display when switching to history tab
            if (tabName === 'history') {
                displayHistory();
                updateHistoryStats();
            }
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification show';
            if (type === 'error') {
                notification.classList.add('error');
            }
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // ============================================
        // PHONE NUMBER PROCESSING
        // ============================================
        
        // Clean phone number (remove all non-digits except leading +)
        function cleanPhoneNumber(phone) {
            if (!phone) return '';
            // Keep the + if it's at the beginning, remove all other non-digits
            const hasPlus = phone.toString().trim().startsWith('+');
            const digits = phone.toString().replace(/[^\d]/g, '');
            return hasPlus ? '+' + digits : digits;
        }

        // Format phone number for display
        function formatPhoneForAPI(phone) {
            const cleaned = cleanPhoneNumber(phone);
            // Ensure it starts with + for Twilio API
            return cleaned.startsWith('+') ? cleaned : '+' + cleaned;
        }

        // ============================================
        // SINGLE NUMBER GENERATION
        // ============================================
        
        // Generate single link without Twilio
        function generateSingleLink() {
            const businessName = document.getElementById('businessName').value.trim() || 'N/A';
            const phoneInput = document.getElementById('phoneNumber').value;
            const phone = cleanPhoneNumber(phoneInput);

            if (!phone || !/^\+?\d+$/.test(phone)) {
                alert('Please enter a valid phone number');
                return;
            }

            const cleanPhone = phone.replace(/\+/g, '');
            const link = `https://wa.me/${cleanPhone}`;
            
            // Add to history
            const status = addToHistory(businessName, phone, link);
            saveHistory();
            
            // Display result
            displaySingleResult(businessName, phone, link, null, status);
        }

        // Generate single link with Twilio lookup
        async function generateWithTwilio() {
            const businessName = document.getElementById('businessName').value.trim() || 'N/A';
            const phoneInput = document.getElementById('phoneNumber').value;
            const phone = cleanPhoneNumber(phoneInput);

            if (!phone || !/^\+?\d+$/.test(phone)) {
                alert('Please enter a valid phone number');
                return;
            }

            const cleanPhone = phone.replace(/\+/g, '');
            const link = `https://wa.me/${cleanPhone}`;
            
            // Perform Twilio lookup
            showNotification('Looking up number...');
            const twilioData = await twilioLookup(formatPhoneForAPI(phone));
            
            // Add to history
            const status = addToHistory(businessName, phone, link, twilioData);
            saveHistory();
            
            // Display result
            displaySingleResult(businessName, phone, link, twilioData, status);
        }

        // Display single result in table
        function displaySingleResult(businessName, phone, link, twilioData, status) {
            const tbody = document.getElementById('singleResultBody');
            tbody.innerHTML = '';

            const row = tbody.insertRow();
            const statusBadge = status === 'updated' ? 
                '<span class="badge badge-updated">Updated</span>' : 
                '<span class="badge badge-new">New</span>';
            
            const typeBadge = getTypeBadge(twilioData?.type);
            
            row.innerHTML = `
                <td>${businessName} ${statusBadge}</td>
                <td>${phone}</td>
                <td>${typeBadge}</td>
                <td>${twilioData?.carrier || 'N/A'}</td>
                <td>${twilioData?.country || 'N/A'}</td>
                <td>
                    <div class="link-cell">
                        <a href="${link}" target="_blank">${link}</a>
                        <button class="btn-copy" onclick="copyToClipboard('${link}', this)">📋 Copy</button>
                    </div>
                </td>
            `;

            document.getElementById('singleResultTable').classList.add('show');
        }

        // ============================================
        // TWILIO API INTEGRATION
        // ============================================
        
        // Perform Twilio lookup for a single number
        async function twilioLookup(phoneNumber) {
            try {
                const response = await fetch('/api/lookup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ numbers: [formatPhoneForAPI(phoneNumber)] })
                });

                if (!response.ok) {
                    return null;
                }

                const data = await response.json();
                const item = Array.isArray(data.results) ? data.results[0] : null;
                if (!item || item.error) {
                    return null;
                }

                return {
                    type: item.type || 'unknown',
                    carrier: item.carrier || 'Unknown',
                    country: item.country || 'Unknown',
                    valid: typeof item.valid === 'boolean' ? item.valid : true
                };
            } catch (error) {
                console.error('Lookup via API error:', error);
                return null;
            }
        }

        // Single Twilio lookup from Twilio tab
        async function twilioSingleLookup() {
            const phoneInput = document.getElementById('twilioPhone').value;
            const phone = cleanPhoneNumber(phoneInput);

            if (!phone || !/^\+?\d+$/.test(phone)) {
                alert('Please enter a valid phone number');
                return;
            }

            const loading = document.getElementById('twilioLoading');
            loading.style.display = 'inline-block';

            try {
                const twilioData = await twilioLookup(formatPhoneForAPI(phone));
                
                if (twilioData) {
                    const resultDiv = document.getElementById('twilioResult');
                    const resultContent = document.getElementById('twilioResultContent');
                    
                    resultContent.innerHTML = `
                        <p><strong>Phone Number:</strong> ${phone}</p>
                        <p><strong>Type:</strong> ${getTypeBadge(twilioData.type)}</p>
                        <p><strong>Carrier:</strong> ${twilioData.carrier}</p>
                        <p><strong>Country:</strong> ${twilioData.country}</p>
                        <p><strong>Valid:</strong> ${twilioData.valid ? '✅ Yes' : '❌ No'}</p>
                    `;
                    
                    resultDiv.style.display = 'block';
                    showNotification('✅ Lookup successful');
                } else {
                    showNotification('Unable to look up numbers right now, please try again later.', 'error');
                }
            } catch (error) {
                console.error('Lookup error:', error);
                showNotification('Unable to look up numbers right now, please try again later.', 'error');
            } finally {
                loading.style.display = 'none';
            }
        }

        // Test Twilio connection
        async function testTwilioConnection() {
            showNotification('Testing connection...');
            
            try {
                // Test with a known valid number
                const result = await twilioLookup('+12025550123');
                if (result !== null) {
                    showNotification('✅ Connection successful!');
                } else {
                    showNotification('Unable to look up numbers right now, please try again later.', 'error');
                }
            } catch (error) {
                showNotification('Unable to look up numbers right now, please try again later.', 'error');
            }
        }

        // ============================================
        // CSV PROCESSING
        // ============================================
        
        // Parse CSV
        function parseCSV(text) {
            const lines = text.split(/\r?\n/);
            const result = [];
            let headers = [];

            if (lines.length > 0) {
                headers = parseCSVLine(lines[0]);
            }

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line) {
                    const values = parseCSVLine(line);
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] || '';
                    });
                    result.push(row);
                }
            }

            return { headers, data: result };
        }

        // Parse single CSV line
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];

                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());

            return result;
        }

        // Auto-detect columns
        function autoDetectColumns(headers) {
            const nameKeywords = ['name', 'business', 'company', 'shop', 'store', 'vendor', 'client', 'customer', 'organization', 'org', 'nombre', 'empresa'];
            const phoneKeywords = ['phone', 'mobile', 'number', 'contact', 'tel', 'cell', 'whatsapp', 'wa', 'telefono', 'celular', 'numero'];

            let nameColumn = null;
            let phoneColumn = null;
            let nameConfidence = 0;
            let phoneConfidence = 0;

            headers.forEach(header => {
                const lowerHeader = header.toLowerCase().trim();

                nameKeywords.forEach(keyword => {
                    if (lowerHeader.includes(keyword)) {
                        const confidence = keyword.length / lowerHeader.length;
                        if (confidence > nameConfidence) {
                            nameConfidence = confidence;
                            nameColumn = header;
                        }
                    }
                });

                phoneKeywords.forEach(keyword => {
                    if (lowerHeader.includes(keyword)) {
                        const confidence = keyword.length / lowerHeader.length;
                        if (confidence > phoneConfidence) {
                            phoneConfidence = confidence;
                            phoneColumn = header;
                        }
                    }
                });
            });

            return { 
                name: { column: nameColumn, confidence: nameConfidence },
                phone: { column: phoneColumn, confidence: phoneConfidence }
            };
        }

        // Handle file selection for main CSV upload
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) {
                csvData = [];
                csvHeaders = [];
                document.getElementById('fileInfo').classList.remove('show');
                document.getElementById('columnSelector').classList.remove('show');
                return;
            }

            const fileSize = (file.size / 1024).toFixed(2);
            const fileInfo = document.getElementById('fileInfo');
            fileInfo.innerHTML = `✅ File loaded: <strong>${file.name}</strong> (${fileSize} KB)`;
            fileInfo.classList.add('show');

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const parsed = parseCSV(text);
                csvData = parsed.data;
                csvHeaders = parsed.headers;

                const detected = autoDetectColumns(csvHeaders);
                populateColumnSelectors(csvHeaders, detected);
                document.getElementById('columnSelector').classList.add('show');
                updatePreview();
            };
            reader.readAsText(file);
        }

        // Handle file selection for Twilio CSV upload
        function handleTwilioFileSelect(event) {
            const file = event.target.files[0];
            if (!file) {
                twilioCsvData = [];
                document.getElementById('twilioBulkBtn').disabled = true;
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const parsed = parseCSV(text);
                twilioCsvData = parsed.data;
                document.getElementById('twilioBulkBtn').disabled = false;
                showNotification(`✅ Loaded ${twilioCsvData.length} rows`);
            };
            reader.readAsText(file);
        }

        // Populate column selectors
        function populateColumnSelectors(headers, detected) {
            const nameSelect = document.getElementById('nameColumnSelect');
            const phoneSelect = document.getElementById('phoneColumnSelect');
            
            nameSelect.innerHTML = '<option value="">-- None / Skip --</option>';
            phoneSelect.innerHTML = '<option value="">-- Select Column --</option>';

            headers.forEach(header => {
                nameSelect.innerHTML += `<option value="${header}">${header}</option>`;
                phoneSelect.innerHTML += `<option value="${header}">${header}</option>`;
            });

            if (detected.name.column) {
                nameSelect.value = detected.name.column;
                const status = document.getElementById('nameDetectionStatus');
                if (detected.name.confidence > 0.5) {
                    status.className = 'detection-status success';
                    status.innerHTML = '✓ Auto-detected';
                } else {
                    status.className = 'detection-status warning';
                    status.innerHTML = '⚠ Possible match';
                }
            }

            if (detected.phone.column) {
                phoneSelect.value = detected.phone.column;
                const status = document.getElementById('phoneDetectionStatus');
                if (detected.phone.confidence > 0.5) {
                    status.className = 'detection-status success';
                    status.innerHTML = '✓ Auto-detected';
                } else {
                    status.className = 'detection-status warning';
                    status.innerHTML = '⚠ Possible match';
                }
            }

            nameSelect.addEventListener('change', updatePreview);
            phoneSelect.addEventListener('change', updatePreview);
        }

        // Update preview
        function updatePreview() {
            const nameColumn = document.getElementById('nameColumnSelect').value;
            const phoneColumn = document.getElementById('phoneColumnSelect').value;
            const previewContent = document.getElementById('previewContent');

            if (csvData.length === 0) {
                previewContent.innerHTML = '<p style="color: #666;">No data available</p>';
                return;
            }

            const firstRow = csvData[0];
            let html = '<div class="preview-row">';
            
            if (nameColumn) {
                html += `
                    <div class="preview-item">
                        <strong>Business Name:</strong>
                        ${firstRow[nameColumn] || 'N/A'}
                    </div>
                `;
            } else {
                html += `
                    <div class="preview-item">
                        <strong>Business Name:</strong>
                        <span style="color: #999;">Not selected</span>
                    </div>
                `;
            }

            if (phoneColumn) {
                const phone = cleanPhoneNumber(firstRow[phoneColumn] || '');
                html += `
                    <div class="preview-item">
                        <strong>Phone Number:</strong>
                        ${phone || 'N/A'}
                    </div>
                `;
            } else {
                html += `
                    <div class="preview-item">
                        <strong>Phone Number:</strong>
                        <span style="color: #999;">Not selected</span>
                    </div>
                `;
            }

            html += '</div>';
            previewContent.innerHTML = html;
        }

        // Process CSV without Twilio
        function confirmColumnSelection() {
            const nameColumn = document.getElementById('nameColumnSelect').value;
            const phoneColumn = document.getElementById('phoneColumnSelect').value;

            if (!phoneColumn) {
                alert('Please select a phone number column');
                return;
            }

            selectedColumns.name = nameColumn;
            selectedColumns.phone = phoneColumn;

            processBulkCSV(false);
        }

        // Process CSV with Twilio
        function confirmColumnSelectionWithTwilio() {
            if (!twilioCredentials.sid || !twilioCredentials.token) {
                alert('Please configure your Twilio credentials in Settings first');
                switchTab('settings');
                return;
            }

            const nameColumn = document.getElementById('nameColumnSelect').value;
            const phoneColumn = document.getElementById('phoneColumnSelect').value;

            if (!phoneColumn) {
                alert('Please select a phone number column');
                return;
            }

            selectedColumns.name = nameColumn;
            selectedColumns.phone = phoneColumn;

            processBulkCSV(true);
        }

        // Process bulk CSV
        async function processBulkCSV(useTwilio = false) {
            if (!csvData || csvData.length === 0) {
                alert('No data to process');
                return;
            }

            bulkData = [];
            let processedCount = 0;
            let successCount = 0;
            let mobileCount = 0;
            let duplicatesCount = 0;

            const tbody = document.getElementById('bulkResultsBody');
            tbody.innerHTML = '';

            showNotification(`Processing ${csvData.length} rows...`);

            for (const row of csvData) {
                const businessName = selectedColumns.name ? (row[selectedColumns.name] || 'N/A') : 'N/A';
                const phoneRaw = row[selectedColumns.phone] || '';
                const phone = cleanPhoneNumber(phoneRaw);

                processedCount++;

                if (phone && /^\+?\d+$/.test(phone)) {
                    const cleanPhone = phone.replace(/\+/g, '');
                    const link = `https://wa.me/${cleanPhone}`;
                    
                    let twilioData = null;
                    if (useTwilio) {
                        twilioData = await twilioLookup(formatPhoneForAPI(phone));
                        if (twilioData?.type === 'mobile') {
                            mobileCount++;
                        }
                    }
                    
                    // Add to history
                    const status = addToHistory(businessName, phone, link, twilioData);
                    if (status === 'updated') {
                        duplicatesCount++;
                    }
                    
                    bulkData.push({
                        businessName: businessName,
                        phone: phone,
                        link: link,
                        valid: true,
                        status: status,
                        twilioData: twilioData
                    });

                    const tr = tbody.insertRow();
                    const statusBadge = status === 'updated' ? 
                        '<span class="badge badge-updated">Updated</span>' : 
                        '<span class="badge badge-new">New</span>';
                    
                    const typeBadge = getTypeBadge(twilioData?.type);
                    
                    tr.innerHTML = `
                        <td>${businessName} ${statusBadge}</td>
                        <td>${phone}</td>
                        <td>${typeBadge}</td>
                        <td>${twilioData?.carrier || 'N/A'}</td>
                        <td>${twilioData?.country || 'N/A'}</td>
                        <td>
                            <div class="link-cell">
                                <a href="${link}" target="_blank">${link}</a>
                                <button class="btn-copy" onclick="copyToClipboard('${link}', this)">📋 Copy</button>
                            </div>
                        </td>
                    `;
                    
                    successCount++;
                } else if (phoneRaw) {
                    bulkData.push({
                        businessName: businessName,
                        phone: phoneRaw,
                        link: 'Invalid',
                        valid: false
                    });

                    const tr = tbody.insertRow();
                    tr.style.opacity = '0.6';
                    tr.innerHTML = `
                        <td>${businessName}</td>
                        <td style="color: red;">${phoneRaw} (Invalid)</td>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                        <td style="color: red;">Invalid phone format</td>
                    `;
                }
            }

            // Save history after bulk processing
            saveHistory();

            // Update stats
            document.getElementById('totalProcessed').textContent = processedCount;
            document.getElementById('totalSuccess').textContent = successCount;
            document.getElementById('totalMobile').textContent = mobileCount;
            document.getElementById('totalDuplicates').textContent = duplicatesCount;

            // Show results
            document.getElementById('columnSelector').classList.remove('show');
            document.getElementById('bulkStats').style.display = 'flex';
            document.getElementById('resultsContainer').classList.add('show');

            if (successCount > 0) {
                document.getElementById('downloadSection').classList.add('show');
            }

            showNotification(`✅ Processed ${processedCount} rows successfully`);
        }

        // Bulk Twilio lookup
        async function twilioBulkLookup() {
            if (!twilioCsvData || twilioCsvData.length === 0) {
                alert('Please upload a CSV file first');
                return;
            }

            const loading = document.getElementById('twilioBulkLoading');
            loading.style.display = 'inline-block';

            const detected = autoDetectColumns(Object.keys(twilioCsvData[0]));
            const phoneColumn = detected.phone.column;

            if (!phoneColumn) {
                alert('Could not detect phone number column in the CSV');
                loading.style.display = 'none';
                return;
            }

            showNotification(`Processing ${twilioCsvData.length} phone numbers...`);

            // Gather numbers and perform a single batched API lookup
            const numbers = [];
            for (const row of twilioCsvData) {
                const phone = cleanPhoneNumber(row[phoneColumn]);
                if (phone && /^\+?\d+$/.test(phone)) {
                    numbers.push(formatPhoneForAPI(phone));
                }
            }

            try {
                const response = await fetch('/api/lookup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ numbers })
                });

                if (!response.ok) {
                    throw new Error('lookup_failed');
                }

                const data = await response.json();
                const results = (data.results || []).map(item => ({
                    phone: item.number || '',
                    type: item.type || 'unknown',
                    carrier: item.carrier || 'Unknown',
                    country: item.country || 'Unknown',
                    valid: typeof item.valid === 'boolean' ? item.valid : true
                }));

                loading.style.display = 'none';
                showNotification(`✅ Completed lookup for ${results.length} numbers`);

                // Render results in the bulk results table
                const container = document.getElementById('twilioBulkResults');
                const tbody = document.getElementById('twilioBulkBody');
                tbody.innerHTML = '';

                results.forEach(item => {
                    const tr = document.createElement('tr');
                    const typeBadge = getTypeBadge(item.type);
                    const statusText = item.valid ? '✅ OK' : '❌ Invalid';

                    tr.innerHTML = `
                        <td>${item.phone || item.number || ''}</td>
                        <td>${typeBadge}</td>
                        <td>${item.carrier || 'Unknown'}</td>
                        <td>${item.country || 'Unknown'}</td>
                        <td>${typeof item.valid === 'boolean' ? (item.valid ? 'Yes' : 'No') : 'Yes'}</td>
                        <td>${item.error ? `<span style="color: red;">${item.error}</span>` : statusText}</td>
                    `;
                    tbody.appendChild(tr);
                });

                container.style.display = 'block';
            } catch (error) {
                loading.style.display = 'none';
                showNotification('Unable to look up numbers right now, please try again later.', 'error');
            }
        }

        // ============================================
        // HISTORY DISPLAY AND MANAGEMENT
        // ============================================
        
        // Display history
        function displayHistory() {
            const tbody = document.getElementById('historyBody');
            const searchTerm = document.getElementById('historySearch').value.toLowerCase();
            
            tbody.innerHTML = '';
            
            let filteredHistory = history;
            if (searchTerm) {
                filteredHistory = history.filter(item => 
                    item.businessName.toLowerCase().includes(searchTerm) ||
                    item.phone.includes(searchTerm)
                );
            }
            
            if (filteredHistory.length === 0) {
                document.getElementById('historyTable').style.display = 'none';
                document.getElementById('emptyHistory').style.display = 'block';
                return;
            }
            
            document.getElementById('historyTable').style.display = 'table';
            document.getElementById('emptyHistory').style.display = 'none';
            
            filteredHistory.forEach(item => {
                const tr = tbody.insertRow();
                const date = new Date(item.timestamp);
                const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                const typeBadge = getTypeBadge(item.type);
                
                tr.innerHTML = `
                    <td>${item.businessName}</td>
                    <td>${item.phone}</td>
                    <td>${typeBadge}</td>
                    <td>${item.carrier || 'N/A'}</td>
                    <td>${item.country || 'N/A'}</td>
                    <td>
                        <div class="link-cell">
                            <a href="${item.link}" target="_blank">${item.link}</a>
                            <button class="btn-copy" onclick="copyToClipboard('${item.link}', this)">📋 Copy</button>
                        </div>
                    </td>
                    <td class="timestamp">${formattedDate}</td>
                `;
            });
        }

        // Filter history
        function filterHistory() {
            displayHistory();
        }

        // Update history stats
        function updateHistoryStats() {
            document.getElementById('totalHistoryCount').textContent = history.length;
            
            const uniqueBusinesses = new Set(history.map(item => item.businessName)).size;
            document.getElementById('uniqueBusinesses').textContent = uniqueBusinesses;
            
            const mobileNumbers = history.filter(item => item.type === 'mobile').length;
            document.getElementById('mobileCount').textContent = mobileNumbers;
            
            const today = new Date().toDateString();
            const todayCount = history.filter(item => 
                new Date(item.timestamp).toDateString() === today
            ).length;
            document.getElementById('todayCount').textContent = todayCount;
            
            // Update badge
            const badge = document.getElementById('historyCount');
            if (history.length > 0) {
                badge.textContent = history.length;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }

        // Clear history
        function clearHistory() {
            if (history.length === 0) {
                alert('History is already empty');
                return;
            }
            
            if (confirm(`Are you sure you want to delete all ${history.length} entries from history? This cannot be undone.`)) {
                history = [];
                localStorage.removeItem('whatsappHistory');
                displayHistory();
                updateHistoryStats();
                showNotification('✅ History cleared');
            }
        }

        // ============================================
        // EXPORT FUNCTIONS
        // ============================================
        
        // Export history
        function exportHistory() {
            if (history.length === 0) {
                alert('No history to export');
                return;
            }
            
            const BOM = '\uFEFF';
            let csvContent = BOM + 'Business Name,Phone Number,Type,Carrier,Country,WhatsApp Link,Last Updated\n';
            
            history.forEach(item => {
                const name = item.businessName.includes(',') ? `"${item.businessName.replace(/"/g, '""')}"` : item.businessName;
                const date = new Date(item.timestamp).toLocaleString();
                csvContent += `${name},${item.phone},${item.type || 'unknown'},${item.carrier || 'N/A'},${item.country || 'N/A'},${item.link},"${date}"\n`;
            });
            
            downloadFile(csvContent, `whatsapp_history_${getTimestamp()}.csv`, 'text/csv');
        }

        // Download CSV results
        function downloadCSV() {
            if (bulkData.length === 0) {
                alert('No data to download');
                return;
            }

            const BOM = '\uFEFF';
            let csvContent = BOM + 'Business Name,Phone Number,Type,Carrier,Country,WhatsApp Link,Status\n';
            
            bulkData.forEach(item => {
                const name = item.businessName.includes(',') ? `"${item.businessName.replace(/"/g, '""')}"` : item.businessName;
                const link = item.valid ? item.link : 'Invalid';
                const status = item.status === 'updated' ? 'Updated' : 'New';
                const type = item.twilioData?.type || 'unknown';
                const carrier = item.twilioData?.carrier || 'N/A';
                const country = item.twilioData?.country || 'N/A';
                csvContent += `${name},${item.phone},${type},${carrier},${country},${link},${status}\n`;
            });

            downloadFile(csvContent, `whatsapp_links_${getTimestamp()}.csv`, 'text/csv');
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        
        // Copy to clipboard
        function copyToClipboard(text, btn) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = btn.innerHTML;
                btn.innerHTML = '✓ Copied!';
                btn.style.background = '#2e7d32';
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '#128C7E';
                }, 2000);
            }).catch(err => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                const originalText = btn.innerHTML;
                btn.innerHTML = '✓ Copied!';
                btn.style.background = '#2e7d32';
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '#128C7E';
                }, 2000);
            });
        }

        // Get type badge HTML
        function getTypeBadge(type) {
            if (!type || type === 'unknown') {
                return '<span class="badge">Unknown</span>';
            }
            
            const badges = {
                'mobile': '<span class="badge badge-mobile">📱 Mobile</span>',
                'landline': '<span class="badge badge-landline">☎️ Landline</span>',
                'fixedvoip': '<span class="badge badge-voip">🌐 Fixed VoIP</span>',
                'nonfixedvoip': '<span class="badge badge-voip">📞 Non-Fixed VoIP</span>',
                'voip': '<span class="badge badge-voip">📞 VoIP</span>'
            };
            
            return badges[type.toLowerCase()] || `<span class="badge">${type}</span>`;
        }

        // Helper function to download file
        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type: type + ';charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('✅ File downloaded');
        }

        // Get timestamp for filenames
        function getTimestamp() {
            return new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
        }
    </script>
</body>
</html>
```